import os
import hashlib
import magic
import pandas as pd
from PyPDF2 import PdfReader
from PIL import Image
from PIL.ExifTags import TAGS

def extract_file_features(file_path):
    features = {}

    # Basic file attributes
    features['file_size'] = os.path.getsize(file_path)

    # Calculate hash
    hash_md5 = hashlib.md5()
    with open(file_path, 'rb') as file:
        for chunk in iter(lambda: file.read(4096), b''):
            hash_md5.update(chunk)
    features['md5_hash'] = hash_md5.hexdigest()

    # Extract metadata based on file type
    file_type = magic.Magic()
    detected_type = file_type.from_file(file_path)
    #print(detected_type)
    
    # If the detected file type is PDF, extract PDF-specific features
    if 'PDF document' in detected_type:
        
        try:
            with open(file_path, 'rb') as file:
                pdf_reader = PdfReader(file)
                features['num_pages'] = len(pdf_reader.pages)

                # Extract document properties
                document_info = pdf_reader.metadata
                for key, value in document_info.items():
                    features[f'pdf_{key.lower().replace(" ", "_")}'] = value


                print(features[f'pdf_{key.lower().replace(" ", "_")}'])

                # Extract byte sequences
                byte_sequences = []
                for page_num in range(features['num_pages']):
                    #print("entered byte")
                    page = pdf_reader.pages[page_num]
                    page_content = page.extract_text().encode('utf-8', 'ignore')
                    byte_sequences.extend(page_content)
                features['byte_sequences'] = byte_sequences

                #print(features['byte_sequences'])

                # Extract embedded objects count and types
                embedded_objects_count = 0
                embedded_objects_types = set()
                for page_num in range(features['num_pages']):
                    
                    page = pdf_reader.pages[page_num]
                    if '/XObject' in page['/Resources']:
                        xobjects = page['/Resources']['/XObject'].keys()
                        for obj in xobjects:
                            obj_type = page['/Resources']['/XObject'][obj]['/Subtype']
                            embedded_objects_types.add(obj_type)
                            embedded_objects_count += 1

                features['embedded_objects_count'] = embedded_objects_count
                features['embedded_objects_types'] = list(embedded_objects_types)

                print(features['embedded_objects_types'])

        except Exception as e:
            print("PDF Error:", e)
            features['num_pages'] = 0


    # If the detected file type is an image, extract image-specific metadata
    elif 'image' in detected_type:
        try:
            image = Image.open(file_path)

            # Extract basic image attributes
            image_info = image.info
            for key, value in image_info.items():
                features[f'image_{key.lower().replace(" ", "_")}'] = value

            # Extract EXIF data
            exif_data = image._getexif()
            if exif_data:
                for tag, value in exif_data.items():
                    tag_name = TAGS.get(tag, tag)
                    features[f'image_exif_{tag_name.lower().replace(" ", "_")}'] = value
        except Exception as e:
            print("Image Error:", e)

    return features

def main():
    file_path = "test_file.pdf"  
    feat = extract_file_features(file_path)
    #print(feat)
    

if __name__ == "__main__":
    main()



